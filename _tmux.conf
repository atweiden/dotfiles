#
# ----------------------------------------------------------
# General Options
# ----------------------------------------------------------
#

# Expect UTF-8.
setw -g utf8 on

# Time after which the -r (repeat) in bind -r expires.
set -g repeat-time 300

# Unbind keys.
unbind C-b
unbind '"'
unbind %
unbind s

# Screen prefix key.
set -g prefix C-a
bind a send-prefix

# Vim keys.
setw -g xterm-keys on
setw -g mode-keys vi
set -sg escape-time 0

# Set default shell to Bash.
set -g default-shell /bin/bash
set -g default-command "/bin/bash"

# Set default TERM.
set -g default-terminal screen

# Update TERM when creating new session or attaching to existing session.
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY TERM"

# Inform programs of 256 color support when available.
if "[[ ${TERM} =~ 256color || ${TERM} == fbterm ]]" "set -g default-terminal screen-it-256color"

# Enable mouse.
setw -g mode-mouse on
set -g mouse-select-pane on
set -g mouse-resize-pane on
set -g mouse-select-window on
set -g mouse-utf8 on

# Scroll back buffer n lines.
set -g history-limit 100000

# Sane scrolling.
set -g terminal-overrides 'xterm*:smcup@:rmcup@'

# Reload config without killing server.
bind R source-file ~/.tmux.conf \; display-message "Config reloaded..."


#
# ----------------------------------------------------------
# Windows and Panes
# ----------------------------------------------------------
#

# Start window indexing at one instead of zero.
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows if they get out of order.
set -g renumber-windows on

# Don't aggressively resize windows.
setw -g aggressive-resize off

# Don't allow running programs to change the window name.
setw -g allow-rename off

# Don't wrap searches around the end of the pane contents.
setw -g wrap-search off

# Swap on <C-a><C-a>.
bind C-a last-window

# URxvt tab-like window switching.
bind -n S-down new-window
bind -n S-left previous-window
bind -n S-right next-window
bind -n C-left swap-window -t -1
bind -n C-right swap-window -t +1

# URxvt tab-like window renaming.
bind -n S-up command-prompt -p "rename window to:" "rename-window '%%'"

# Allow repeats for next/prev window.
bind -r n next-window
bind -r p previous-window

# Vim-like window splitting.
bind v split-window -h
bind s split-window

# Vim-like pane resize.
bind -r 'k' resize-pane -U 1
bind -r 'j' resize-pane -D 1
bind -r 'h' resize-pane -L 1
bind -r 'l' resize-pane -R 1

# Smart pane switching with awareness of Vim splits.
bind -n C-h run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-h) || tmux select-pane -L"
bind -n C-j run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-j) || tmux select-pane -D"
bind -n C-k run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-k) || tmux select-pane -U"
bind -n C-l run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-l) || tmux select-pane -R"
bind -n C-\ run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys 'C-\\') || tmux select-pane -l"
bind C-l send-keys 'C-l'

# Join and break panes.
bind J command-prompt -p "join pane from:"  "join-pane -s '%%'"
bind S command-prompt -p "send pane to:"  "join-pane -t '%%'"
bind B break-pane       # move pane to new window and switch to it
bind D break-pane -d    # move pane to new window in the background

# Select pane with fzf.
bind 0 run "tmux split-window -p 40 'bash -ci ftpane'"


#
# ----------------------------------------------------------
# Terminal Title
# ----------------------------------------------------------
#

# Enable terminal window titles.
set -g set-titles on

# Set terminal title format (uses status bar variables).
set -g set-titles-string "TMUX.#I.#W"

# Don't automatically rename terminal title.
setw -g automatic-rename off


#
# ----------------------------------------------------------
# Status Bar
# ----------------------------------------------------------
#

# Place status bar on top of screen.
set -g status-position top

# Use key map for the status bar.
set -g status-keys vi

# List activity on all windows.
set -g bell-action any

# Set window notifications.
setw -g monitor-activity on
setw -g window-status-activity-attr none
set -g visual-activity off

# Update the status bar every n seconds.
set -g status-interval 5

# On-screen time for display-panes in ms.
set -g display-time 2000

# Use 24-hour time.
setw -g clock-mode-style 24

# Statusbar theme for X sessions or tty.
if '[ -n "$DISPLAY" ] && test -f ~/.tmux/jellybeans-powerline.tmux' 'source ~/.tmux/jellybeans-powerline.tmux'
if '[ -z "$DISPLAY" ]' 'source-file ~/.tmux/xless.tmux'


#
# ----------------------------------------------------------
# Plugin Settings
# ----------------------------------------------------------
#

# Vim-like next / prev search
set -g @copycat_next "N"
set -g @copycat_prev "n"


#
# ----------------------------------------------------------
# Plugins
# ----------------------------------------------------------
#

# https://github.com/tmux-plugins
#set -g @tpm_plugins "              \
  #tmux-plugins/tpm                 \
  #tmux-plugins/tmux-copycat        \
  #tmux-plugins/tmux-yank           \
  #tmux-plugins/tmux-logging        \
  #tmux-plugins/tmux-resurrect      \
  #tmux-plugins/tmux-sessionist     \
#"

run ~/.tmux/plugins/tmux-copycat/copycat.tmux
run ~/.tmux/plugins/tmux-yank/yank.tmux
run ~/.tmux/plugins/tmux-logging/logging.tmux
run ~/.tmux/plugins/tmux-resurrect/resurrect.tmux
run ~/.tmux/plugins/tmux-sessionist/sessionist.tmux
